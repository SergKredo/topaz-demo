<div class="page">
	<div class="page-header">
		<h1 class="title">Topaz Signature Demo</h1>
	</div>

	<div class="grid">
		<section class="card">
			<h2 class="card-title">Status</h2>
			<div class="badges">
				<span
					class="badge"
					[class.badge-ok]="topaz.sdkLoaded()"
					[class.badge-error]="!topaz.sdkLoaded()"
					title="Whether the SigWebTablet JS SDK was loaded into the page."
				>
					SDK: {{ topaz.sdkLoaded() ? 'Loaded' : 'Missing' }}
				</span>
				<span
					class="badge"
					[class.badge-ok]="topaz.sigwebInstalled() === true"
					[class.badge-error]="topaz.sigwebInstalled() === false"
					[class.badge-warn]="topaz.sigwebInstalled() === null"
					title="Best-effort check for whether SigWeb is installed on this machine."
				>
					SigWeb: {{ topaz.sigwebInstalled() === null ? 'Unknown' : (topaz.sigwebInstalled() ? 'Installed' : 'Not detected') }}
				</span>
				<span
					class="badge"
					[class.badge-warn]="topaz.isGitHubPages()"
					title="If you're on GitHub Pages, SigWeb must still be installed and running locally on your PC."
				>
					Host: {{ topaz.isGitHubPages() ? 'GitHub Pages' : 'Local' }}
				</span>
				<span
					class="badge"
					[class.badge-ok]="topaz.tabletConnected() === true"
					[class.badge-error]="topaz.tabletConnected() === false"
					[class.badge-warn]="topaz.tabletConnected() === null"
					title="Whether SigWeb currently detects a tablet."
				>
					Tablet: {{ topaz.tabletConnected() === null ? 'Unknown' : (topaz.tabletConnected() ? 'Connected' : 'Not found') }}
				</span>
			</div>
			<div class="kv" title="SigWeb service version (verifies the SDK/service is reachable).">SigWeb version: <span class="mono">{{ topaz.version() ?? '—' }}</span></div>
			<div class="kv">
				Tablet connected:
				<span class="mono" title="Whether SigWeb currently detects a signature tablet (must be Yes to capture).">{{ topaz.tabletConnected() === null ? '—' : (topaz.tabletConnected() ? 'Yes' : 'No') }}</span>
			</div>
			<label class="kv" title="When enabled, the page periodically refreshes status/stats.">
				<input type="checkbox" [checked]="autoRefreshEnabled" (change)="setAutoRefresh($any($event.target).checked)" />
				Auto-refresh
			</label>
			<div class="kv" *ngIf="topaz.lastAction()">Last action: <span class="mono">{{ topaz.lastAction() }}</span></div>
			<div class="kv prewrap" *ngIf="topaz.lastError()">Error: <span class="mono">{{ topaz.lastError() }}</span></div>
			<div class="hint" title="Typical flow: Start → sign on the tablet → Save to fetch image.">
				Steps: 1) Click Start 2) Sign on the tablet 3) Click Save to show image.
			</div>
		</section>

		<section class="card">
			<h2 class="card-title">Capture</h2>
			<div class="actions">
				<button class="btn btn-primary" type="button" (click)="start()" title="Start signature capture (SDK opens tablet and enables capture mode).">Start</button>
				<button class="btn" type="button" (click)="stop()" title="Stop signature capture (turn capture OFF, without necessarily closing the tablet session).">Stop</button>
				<button class="btn" type="button" (click)="closeTablet()" title="Close the tablet/session in SigWeb. Useful after finishing or to reset the device state.">Close</button>
				<button class="btn" type="button" (click)="clear()" title="Clear the current signature buffer (start over).">Clear</button>
				<button class="btn" type="button" (click)="save()" [disabled]="!topaz.hasSignature()" title="Fetch signature image from SigWeb and display it below.">Save</button>
				<button class="btn" type="button" (click)="downloadImage()" [disabled]="!signatureImage" title="Download the currently displayed signature image as PNG.">Download PNG</button>
				<button class="btn" type="button" (click)="copyImage()" [disabled]="!signatureImage" title="Copy the currently displayed signature image to the clipboard (browser support varies).">Copy PNG</button>
			</div>
			<div class="signature-preview">
				<img *ngIf="signatureImage" [src]="signatureImage" />
			</div>
		</section>
	</div>

	<section class="card">
		<h2 class="card-title">SDK Tools</h2>
		<div class="actions">
			<button class="btn" type="button" (click)="refreshDeviceInfo()" title="Read model/serial/firmware from SigWeb for diagnostics.">Refresh device info</button>
			<button class="btn" type="button" (click)="refreshStats()" title="Refresh capture statistics: total points and stroke count.">Refresh stats</button>
			<button class="btn" type="button" (click)="exportSigString()" title="Export the signature as a text string (SigString) so it can be stored or transferred.">Export SigString</button>
			<button class="btn" type="button" (click)="importSigString()" title="Import a SigString from the text area back into SigWeb (restores the signature).">Import SigString</button>
			<button class="btn" type="button" (click)="copySigString()" title="Copy the SigString in the text area to clipboard.">Copy SigString</button>
			<button class="btn" type="button" (click)="downloadSigString()" title="Download the SigString in the text area as a .txt file.">Download SigString</button>
		</div>

		<div class="stack">
			<div class="kv" title="Whether capture mode is currently enabled in SigWeb.">Capture state: <span class="mono">{{ topaz.tabletCaptureOn() === null ? '—' : (topaz.tabletCaptureOn() ? 'ON' : 'OFF') }}</span></div>
			<div class="kv" title="Tablet model number (if reported by the connected device).">Model: <span class="mono">{{ topaz.tabletModelNumber() ?? '—' }}</span></div>
			<div class="kv" title="Tablet serial number (if reported by the connected device).">Serial: <span class="mono">{{ topaz.tabletSerialNumber() ?? '—' }}</span></div>
			<div class="kv" title="Firmware revision (if reported by the connected device).">Firmware: <span class="mono">{{ topaz.firmwareRevision() ?? '—' }}</span></div>
			<div class="kv" title="Total captured points in the current signature buffer.">Total points: <span class="mono">{{ topaz.totalPoints() ?? '—' }}</span></div>
			<div class="kv" title="Number of strokes (separate pen-down segments) in the current signature.">Strokes: <span class="mono">{{ topaz.numberOfStrokes() ?? '—' }}</span></div>
		</div>

		<div class="divider"></div>

		<div class="kv"><b>SigString:</b></div>
		<textarea
			class="mono"
			rows="5"
			style="width: 100%;"
			title="SigString is a text representation of the signature. Export fills this field; Import loads it back into SigWeb."
			[value]="sigStringDraft"
			(input)="sigStringDraft = $any($event.target).value"
		></textarea>
		<div class="hint">
			Use Export to fill the text area. Use Import to load the text back into SigWeb.
		</div>
	</section>

	<section class="card">
		<h2 class="card-title">Diagnostics</h2>
		<div class="actions">
			<button class="btn" type="button" (click)="clearLog()" title="Clear the on-page event log.">Clear log</button>
		</div>

		<div class="log" *ngIf="topaz.eventLog().length > 0; else emptyLog">
			<div
				class="log-item"
				*ngFor="let item of topaz.eventLog()"
				[class.log-info]="item.level === 'info'"
				[class.log-warn]="item.level === 'warn'"
				[class.log-error]="item.level === 'error'"
			>
				<span class="log-ts mono">{{ item.ts }}</span>
				<span class="log-level mono">{{ item.level }}</span>
				<span class="log-msg">{{ item.message }}</span>
			</div>
		</div>
		<ng-template #emptyLog>
			<div class="hint">No events yet. Actions will appear here.</div>
		</ng-template>

		<div class="divider"></div>

		<details class="troubleshoot">
			<summary class="btn" title="Quick troubleshooting tips for common setup issues.">Troubleshoot</summary>
			<div class="stack" style="margin-top: 0.75rem;">
				<div>
					<b>If SDK is Missing:</b> make sure <span class="mono">SigWebTablet.js</span> loads (no 404 in DevTools → Network).
				</div>
				<div>
					<b>If SigWeb is Not detected:</b> install and start Topaz SigWeb (SigPlusNET). Then reload the page.
				</div>
				<div>
					<b>If Tablet is Not found:</b> connect the device, check drivers, and open the SigWeb app to confirm it detects the tablet.
				</div>
				<div *ngIf="topaz.isGitHubPages()">
					<b>GitHub Pages note:</b> the website is hosted remotely, but SigWeb still runs locally on your PC.
				</div>
			</div>
		</details>
	</section>

	<section class="card" *ngIf="showInternalApiReference">
		<h2 class="card-title">SigWeb REST API (internal reference)</h2>
		<div class="stack">
			<div class="kv"><b>Base URL:</b> <code>{{ topaz.baseUrl }}</code></div>
			<div>
				<b>Typical flow:</b>
				<code>Start</code> → sign on the tablet → <code>Save</code> (fetch image) → <code>Clear</code>.
			</div>
			<div>
				<b>HTTP rules:</b>
				Supported approach is via <code>sigwebtablet.js</code> / <code>SigWebTablet</code>.
				Direct <code>POST</code> calls to command endpoints may fail depending on SigWeb version and browser/CORS behavior.
			</div>
			<div>
				<b>Note:</b> the SDK is essentially a wrapper around these endpoints.
				You normally do not call them directly from Angular.
			</div>
			<div>
				<b>Important:</b>
				SigWeb must detect the device (see <code>/TabletConnectQuery</code>). If it returns <code>0</code>, capture/image
				endpoints may return empty results.
			</div>
		</div>

		<div class="divider"></div>

		<h3 class="section-title">Verified endpoints (this demo uses)</h3>
<div *ngFor="let item of apiDocs">
	<div *ngIf="item.group === 'Verified endpoints (this demo uses)'"><button type="button" class="api-link" (click)="toggleApiDetails(item.id)"><code>{{ item.method }} {{ item.path }}</code> — {{ item.short }}</button></div>
	<div *ngIf="expandedApiId === item.id" class="api-details">
		<div *ngIf="item.purpose.length">
			<b>What it does:</b>
			<ul>
				<li *ngFor="let line of item.purpose">{{ line }}</li>
			</ul>
		</div>
		<div *ngIf="item.params?.length">
			<b>Parameters:</b>
			<ul>
				<li *ngFor="let p of item.params"><code>{{ p.location }}</code> <code>{{ p.name }}</code> — {{ p.meaning }}<span *ngIf="p.example"> (e.g. <code>{{ p.example }}</code>)</span></li>
			</ul>
		</div>
		<div *ngIf="item.requestBody?.length">
			<b>Request body:</b>
			<ul>
				<li *ngFor="let line of item.requestBody">{{ line }}</li>
			</ul>
		</div>
		<div *ngIf="item.response?.length">
			<b>Response:</b>
			<ul>
				<li *ngFor="let line of item.response">{{ line }}</li>
			</ul>
		</div>
		<div *ngIf="item.notes?.length">
			<b>Notes:</b>
			<ul>
				<li *ngFor="let line of item.notes">{{ line }}</li>
			</ul>
		</div>
	</div>
</div>

<div class="divider"></div>

		<h3 class="section-title">More available endpoints (from installed SigWeb REST host)</h3>
<div>
	The list below is extracted from the local SigWeb installation. Availability and exact URL shape can vary by
	version/device/configuration.
</div>

		<h4 class="section-subtitle">Tablet / capture</h4>
<div *ngFor="let item of apiDocs">
	<div *ngIf="item.group === 'Tablet / capture'"><button type="button" class="api-link" (click)="toggleApiDetails(item.id)"><code>{{ item.method }} {{ item.path }}</code> — {{ item.short }}</button></div>
	<div *ngIf="expandedApiId === item.id" class="api-details">
		<div *ngIf="item.purpose.length">
			<b>What it does:</b>
			<ul>
				<li *ngFor="let line of item.purpose">{{ line }}</li>
			</ul>
		</div>
		<div *ngIf="item.params?.length">
			<b>Parameters:</b>
			<ul>
				<li *ngFor="let p of item.params"><code>{{ p.location }}</code> <code>{{ p.name }}</code> — {{ p.meaning }}<span *ngIf="p.example"> (e.g. <code>{{ p.example }}</code>)</span></li>
			</ul>
		</div>
		<div *ngIf="item.requestBody?.length">
			<b>Request body:</b>
			<ul>
				<li *ngFor="let line of item.requestBody">{{ line }}</li>
			</ul>
		</div>
		<div *ngIf="item.response?.length">
			<b>Response:</b>
			<ul>
				<li *ngFor="let line of item.response">{{ line }}</li>
			</ul>
		</div>
		<div *ngIf="item.notes?.length">
			<b>Notes:</b>
			<ul>
				<li *ngFor="let line of item.notes">{{ line }}</li>
			</ul>
		</div>
	</div>
</div>

		<h4 class="section-subtitle">Signature data</h4>
<div *ngFor="let item of apiDocs">
	<div *ngIf="item.group === 'Signature data'"><button type="button" class="api-link" (click)="toggleApiDetails(item.id)"><code>{{ item.method }} {{ item.path }}</code> — {{ item.short }}</button></div>
	<div *ngIf="expandedApiId === item.id" class="api-details">
		<div *ngIf="item.purpose.length">
			<b>What it does:</b>
			<ul>
				<li *ngFor="let line of item.purpose">{{ line }}</li>
			</ul>
		</div>
		<div *ngIf="item.params?.length">
			<b>Parameters:</b>
			<ul>
				<li *ngFor="let p of item.params"><code>{{ p.location }}</code> <code>{{ p.name }}</code> — {{ p.meaning }}<span *ngIf="p.example"> (e.g. <code>{{ p.example }}</code>)</span></li>
			</ul>
		</div>
		<div *ngIf="item.requestBody?.length">
			<b>Request body:</b>
			<ul>
				<li *ngFor="let line of item.requestBody">{{ line }}</li>
			</ul>
		</div>
		<div *ngIf="item.response?.length">
			<b>Response:</b>
			<ul>
				<li *ngFor="let line of item.response">{{ line }}</li>
			</ul>
		</div>
		<div *ngIf="item.notes?.length">
			<b>Notes:</b>
			<ul>
				<li *ngFor="let line of item.notes">{{ line }}</li>
			</ul>
		</div>
	</div>
</div>

		<h4 class="section-subtitle">LCD (for LCD-capable tablets)</h4>
<div *ngFor="let item of apiDocs">
	<div *ngIf="item.group === 'LCD (for LCD-capable tablets)'"><button type="button" class="api-link" (click)="toggleApiDetails(item.id)"><code>{{ item.method }} {{ item.path }}</code> — {{ item.short }}</button></div>
	<div *ngIf="expandedApiId === item.id" class="api-details">
		<div *ngIf="item.purpose.length">
			<b>What it does:</b>
			<ul>
				<li *ngFor="let line of item.purpose">{{ line }}</li>
			</ul>
		</div>
		<div *ngIf="item.params?.length">
			<b>Parameters:</b>
			<ul>
				<li *ngFor="let p of item.params"><code>{{ p.location }}</code> <code>{{ p.name }}</code> — {{ p.meaning }}<span *ngIf="p.example"> (e.g. <code>{{ p.example }}</code>)</span></li>
			</ul>
		</div>
		<div *ngIf="item.requestBody?.length">
			<b>Request body:</b>
			<ul>
				<li *ngFor="let line of item.requestBody">{{ line }}</li>
			</ul>
		</div>
		<div *ngIf="item.response?.length">
			<b>Response:</b>
			<ul>
				<li *ngFor="let line of item.response">{{ line }}</li>
			</ul>
		</div>
		<div *ngIf="item.notes?.length">
			<b>Notes:</b>
			<ul>
				<li *ngFor="let line of item.notes">{{ line }}</li>
			</ul>
		</div>
	</div>
</div>

		<h4 class="section-subtitle">Device configuration</h4>
<div *ngFor="let item of apiDocs">
	<div *ngIf="item.group === 'Device configuration'"><button type="button" class="api-link" (click)="toggleApiDetails(item.id)"><code>{{ item.method }} {{ item.path }}</code> — {{ item.short }}</button></div>
	<div *ngIf="expandedApiId === item.id" class="api-details">
		<div *ngIf="item.purpose.length">
			<b>What it does:</b>
			<ul>
				<li *ngFor="let line of item.purpose">{{ line }}</li>
			</ul>
		</div>
		<div *ngIf="item.params?.length">
			<b>Parameters:</b>
			<ul>
				<li *ngFor="let p of item.params"><code>{{ p.location }}</code> <code>{{ p.name }}</code> — {{ p.meaning }}<span *ngIf="p.example"> (e.g. <code>{{ p.example }}</code>)</span></li>
			</ul>
		</div>
		<div *ngIf="item.requestBody?.length">
			<b>Request body:</b>
			<ul>
				<li *ngFor="let line of item.requestBody">{{ line }}</li>
			</ul>
		</div>
		<div *ngIf="item.response?.length">
			<b>Response:</b>
			<ul>
				<li *ngFor="let line of item.response">{{ line }}</li>
			</ul>
		</div>
		<div *ngIf="item.notes?.length">
			<b>Notes:</b>
			<ul>
				<li *ngFor="let line of item.notes">{{ line }}</li>
			</ul>
		</div>
	</div>
</div>

		<h4 class="section-subtitle">Full extracted path list (raw)</h4>
<div>
	<div *ngFor="let group of rawApiGroups">
		<h5 class="group-title">{{ group.name }}</h5>
		<div *ngFor="let item of group.items">
			<div>
				<button type="button" class="api-link" (click)="toggleRawApiDetails(item.key)">
					<code>{{ item.methodGuess }} {{ item.path }}</code>
					<span *ngIf="item.suffix"> (flag <code>{{ item.suffix }}</code>)</span>
					— {{ item.short }}
				</button>
			</div>
			<div *ngIf="expandedRawApiKey === item.key" class="api-details">
				<div><b>Raw token:</b> <code>{{ item.raw }}</code></div>
				<div><b>Call URL:</b> <code>{{ topaz.baseUrl }}{{ item.path }}</code></div>
				<div *ngIf="item.params.length">
					<b>Path parameters:</b>
					<ul>
						<li *ngFor="let p of item.params"><code>{{ p }}</code> — replace in the URL path (example: <code>/.../{{ p }}/...</code>).</li>
					</ul>
				</div>
				<div *ngIf="item.notes.length">
					<b>Notes:</b>
					<ul>
						<li *ngFor="let n of item.notes">{{ n }}</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>
	</section>
</div>
